# 서브쿼리와 뷰를 활용한 유연한 데이터 분석

## 📌 1. 서브쿼리

- `서브쿼리` : SQL문 안에 '부품'처럼 들어가는 SELECT문, 전체 SQL문에서 일부를 이루는 또 다른 SQL문
- Sub(하위의, 일부분의) + Query(데이터베이스에 보내는 요청)
- 사용 예시) 평점이 평균보다 낮은 제품들만 조회하고 싶을 때 HAVING 문을 사용하여 조건을 걸 수 있는데 이 때 평균 평점을 모르기 때문에 별도의 쿼리문을 사용해 조회를 한 후에 조건을 걸 수 있는 방법이 있다. 이럴 때 조회하는 **SELECT** **조건문 자체를 조건으로 걸 수 있는데 이것을 서브쿼리라고 한다**

```sql
SELECT i.id, i.name, AVG(star) AS avg_star
FROM item i LEFT OUTER JOIN review r
ON r.item_id=i.id
GROUP BY i.id, i.name 
-- 평균평점 조회하는 문장을 조건으로 걸기 (서브쿼리)
HAVING avg_star < (SELECT AVG(star) FROM review)
ORDER BY avg_star DESC;
```

- 외부쿼리 / 내부쿼리라고 부르기도 한다
- ‼***주의점 : 서브쿼리는 반드시 괄호 안에 작성하기***

### 📝 SELECT절에 있는 서브쿼리

```sql
SELECT 
    id,
    name,
    price,
    (SELECT MAX(price) FROM item) AS max_price
FROM item;
```

## 📌 서브쿼리와 함께 유용하게 사용되는 키워드

### 1. ANY, SOME

- row의 값들 중 하나라도 조건을 만족하는 경우가 있으면 True를 리턴
- `ANY` 와 `SOME`은 같은 기능을 함

```sql
SELECT * FROM theater
WHERE view_count > ANY(SELECT view_count FROM theater WHERE category='ACTION')
AND category != 'ACTION';
```

### 2. ALL

- 모든 경우에 대해서 해당 조건이 성립해야 True를 리턴